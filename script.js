// Состояние приложения
const state = {
    screen: 'setup',
    flowType: 0, // 0 - основной поток, 1 - видовой
    questionNow: 1,
    previousQuestion: 0,
    familyID: 1,
    pageID: 0,
    canContinueScrolling: false,
    collection: {},
    settings: {
        useWiFi: true,
        wifiRealTimeSearch: true,
        checkForUpdates: true,
        autoUpdate: false,
        debugMode: true,
        sleepingMode: true,
        autoOff: true,
        tftReconnect: true
    },
    sleepingMode: false,
    lastUsedTime: Date.now()
};

// Данные определителя (упрощённая версия)
const data = {
    goto_if_true: {
        1: 2, 2: 8, 3: 4, 4: -9, 5: 1055, 6: 1059, 7: -10,
        8: 9, 9: 114, 10: 20, 11: 12, 12: 1085, 13: 1145,
        14: 1370, 15: 16, 16: 1074, 17: -212, 18: 19,
        19: -452, 20: 1335, 21: 1272, 22: 1406, 23: 24,
        24: 25, 25: 1534, 26: -716, 27: 1206, 28: 29,
        29: 1460, 30: 31, 31: 1486, 32: -629, 33: 34,
        34: 1384, 35: 1267, 36: 1387, 37: -346, 38: -41,
        39: -343, 40: 1304, 41: 42, 42: 1526, 43: 1511,
        44: 45, 45: -655, 46: -652, 47: 48, 48: 1398,
        49: 1432, 50: 51, 51: 1167, 52: -351, 53: 1205,
        54: 55, 55: 1449, 56: -537, 57: 58, 58: -654,
        59: 1427, 60: 61, 61: 1435, 62: 1508, 63: 1486,
        64: 65, 65: -544, 66: -543, 67: 1447, 68: -549,
        69: 1369, 70: 71, 71: 1295, 72: -42, 73: -38,
        74: 75, 75: 1361, 76: 1364, 77: -483, 78: 1366,
        79: 1226, 80: 82, 81: -352, 82: -523, 83: -350,
        84: -169, 85: -173, 86: 87, 87: 1153, 88: -168,
        89: -39, 90: 91, 91: 92, 92: -387, 93: -385,
        94: -245, 95: 1202, 96: 1226, 97: 1199, 98: 1147,
        99: -44, 100: 101, 101: 102, 102: 103, 103: -45,
        104: -490, 105: -225, 106: 107, 107: 1076, 108: -493,
        109: -37, 110: -43, 111: 1507, 112: -534, 113: 1404,
        114: -291, 115: 1267, 116: 117, 117: -460, 118: 1170,
        119: 1389, 120: 121, 121: -26, 122: 123, 123: 124,
        124: 1335, 125: 128, 126: 1177, 127: 1189, 128: -540,
        129: 130, 130: -539, 131: -459, 132: 1347, 133: -453,
        134: -305, 135: 1395, 136: -599, 137: 1376, 138: -480,
        139: 1381, 140: 141, 141: -518, 142: 1298, 143: 144,
        144: -353, 145: -463, 146: 147, 147: 1177, 148: 1189,
        149: 150, 150: -458, 151: 152, 152: 1304, 153: -480
    },
    
    goto_if_false: {
        1: 120, 2: 3, 3: 5, 4: -20, 5: 6, 6: 7, 7: 1049,
        8: 98, 9: 10, 10: 11, 11: 13, 12: 1127, 13: 14,
        14: 15, 15: 17, 16: 1072, 17: 18, 18: 1216, 19: -493,
        20: 21, 21: 22, 22: 23, 23: 26, 24: 1524, 25: -670,
        26: 27, 27: 28, 28: 30, 29: 1451, 30: 33, 31: 32,
        32: -630, 33: 41, 34: 35, 35: 36, 36: 37, 37: 38,
        38: 39, 39: 40, 40: 1247, 41: 54, 42: 43, 43: 44,
        44: 47, 45: 46, 46: -564, 47: 50, 48: 49, 49: 1529,
        50: 52, 51: 1170, 52: 53, 53: -215, 54: 56, 55: -522,
        56: 57, 57: 69, 58: 59, 59: 60, 60: 62, 61: -538,
        62: 63, 63: 64, 64: 67, 65: 66, 66: 1443, 67: 68,
        68: 1479, 69: 70, 70: 74, 71: 72, 72: 73, 73: -40,
        74: 84, 75: 76, 76: 77, 77: 78, 78: 79, 79: 80,
        80: 81, 81: 1294, 82: 83, 83: 1424, 84: 85, 85: 86,
        86: 90, 87: 83, 88: 89, 89: 1149, 90: 95, 91: 93,
        92: -339, 93: 94, 94: 1216, 95: 96, 96: 97, 97: -446,
        98: 99, 99: 100, 100: 106, 101: -293, 102: 104, 103: 1244,
        104: 105, 105: -34, 106: 111, 107: 108, 108: 109, 109: 110,
        110: -452, 111: 112, 112: 113, 113: -279, 114: 115, 115: 116,
        116: 118, 117: -605, 118: 119, 119: 1247, 120: 122, 121: 1062,
        122: 146, 123: 143, 124: 125, 125: 126, 126: 127, 127: -207,
        128: 129, 129: 140, 130: 131, 131: 132, 132: 133, 133: 134,
        134: 135, 135: 136, 136: 137, 137: 138, 138: 139, 139: 1427,
        140: 142, 141: 1516, 142: 1432, 143: 145, 144: -469, 145: 1304,
        146: 149, 147: 148, 148: -207, 149: 151, 150: -540, 151: 1198,
        152: 153, 153: 1377
    },
    
    questions_true: [
        "Листья, спороносные и бесплодные, все одинаковые",
        "Листья перисторассеченные с перистораздельными долями",
        "Спороносные листья резко отличаются от бесплодных",
        "Спорангии собраны в округлые кучки",
        "Листья дважды-перистораздельные"
    ],
    
    questions_false: [
        "Спороносные листья резко отличаются от бесплодных",
        "Листья цельные или слабораздельные",
        "Спороносные и бесплодные листья сходны",
        "Спорангии собраны в линейные сорусы",
        "Листья простые или слабораздельные"
    ],
    
    resultText: {
        1: {
            title: "Пузырник ломкий",
            pages: [
                "Спорангии собраны в округлые кучки, расположенные по середине боковых жилок, покрытые вздутым покрывалом яйцевидной формы, имеющим вид колпачка, пузыря. У зрелых кучек покрывало сморщивается, а затем исчезает. Листья дважды-перистораздельные, в очертании",
                "продолговатоланцетные, с тонкими буроватыми черешками. Корневище толстое, короткое, листья сидят на нем пучком. Рост 10-30 см. Споры в июне-августе. По облесенным оврагам, затененным откосам, скалам, на известковой почве. Небольшой нежный папоротник, весьма ломкий.",
                "Имеет очень широкое распространение: от Гренландии до Новой Зеландии. Научное название Cystopteris происходит от греческих слов kystis - «пузырь» и pteris - «папоротник», по форме покрывала. Молодые листья обладают запахом горького миндаля. Споры содержат синильную кислоту."
            ]
        },
        2: {
            title: "Страусопер",
            pages: [
                "Спорангии собраны в кучки, расположенные на особых спороносных листьях, по своей величине и форме резко отличающихся от бесплодных. Края сегментов пластинки спороносного листа свернуты до середины жилки...",
                "Толстое корневище с подземными ползучими побегами. Рост 60-100 см. Споры в июле и августе. По сырым лесам.",
                "Может служить декоративным растением. Выдерживает пересадку в сады и парки. Растение ядовитое для скота."
            ]
        }
    }
};

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    setupEventListeners();
    simulateLoading();
});

function initializeApp() {
    // Загрузка состояния из localStorage
    const savedState = localStorage.getItem('plantIdentifierState');
    if (savedState) {
        Object.assign(state, JSON.parse(savedState));
    }
    
    // Загрузка коллекции
    const savedCollection = localStorage.getItem('plantCollection');
    if (savedCollection) {
        state.collection = JSON.parse(savedCollection);
    }
    
    updateUI();
}

function setupEventListeners() {
    // Главный экран
    document.getElementById('start-work').addEventListener('click', () => showScreen('process'));
    document.getElementById('settings').addEventListener('click', () => showScreen('settings'));
    document.getElementById('library').addEventListener('click', () => showScreen('library'));
    
    // Экран определения
    document.querySelector('.true-section').addEventListener('click', () => answerQuestion(1));
    document.querySelector('.false-section').addEventListener('click', () => answerQuestion(0));
    document.getElementById('back-btn').addEventListener('click', () => answerQuestion(2));
    
    // Экран результата
    document.getElementById('result-prev').addEventListener('click', showPrevPage);
    document.getElementById('result-next').addEventListener('click', showNextPage);
    document.getElementById('result-save').addEventListener('click', toggleSavePlant);
    
    // Экран настроек
    document.getElementById('settings-back').addEventListener('click', () => {
        if (state.pageID === 0) {
            showScreen('setup');
        } else {
            state.pageID--;
            updateSettingsScreen();
        }
    });
    
    // Экран библиотеки
    document.getElementById('library-back').addEventListener('click', () => {
        if (state.pageID === 0) {
            showScreen('setup');
        } else {
            state.pageID--;
            updateLibraryScreen();
        }
    });
    
    // Кнопка питания
    document.getElementById('power-btn').addEventListener('click', () => {
        if (state.sleepingMode) {
            wakeUp();
        } else {
            showNotification('Удерживайте для выключения', 5000);
        }
    });
    
    // Таймер сна
    setInterval(() => {
        if (state.settings.sleepingMode && !state.sleepingMode && 
            Date.now() - state.lastUsedTime > 180000) {
            showScreen('sleep');
            state.sleepingMode = true;
        }
    }, 60000);
}

function showScreen(screenName) {
    state.screen = screenName;
    state.lastUsedTime = Date.now();
    
    // Скрыть все экраны
